#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js')
const fs = require('fs')
const path = require('path')

// Colors for console output
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
}

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`)
}

// Product data to add
const newProducts = [
  // Electronics
  {
    name: 'iPad Air 5e g√©n√©ration',
    description: 'Tablette Apple avec puce M1, √©cran Liquid Retina 10.9", parfaite pour le travail et les loisirs',
    price: 699.99,
    compare_at_price: 799.99,
    sku: 'IPAD-AIR-M1',
    inventory_quantity: 30,
    category_slug: 'electronics',
    brand: 'Apple',
    tags: ['tablette', 'apple', 'm1', 'ipad'],
    featured: true
  },
  {
    name: 'Clavier M√©canique RGB',
    description: 'Clavier gaming m√©canique avec r√©tro√©clairage RGB, switches Cherry MX',
    price: 159.99,
    sku: 'KEYBOARD-RGB-MX',
    inventory_quantity: 40,
    category_slug: 'electronics',
    brand: 'GamerTech',
    tags: ['clavier', 'gaming', 'rgb', 'm√©canique']
  },
  {
    name: '√âcran 4K 27 pouces',
    description: 'Moniteur 4K UHD 27" avec HDR, parfait pour le gaming et le design',
    price: 449.99,
    compare_at_price: 549.99,
    sku: 'MONITOR-4K-27',
    inventory_quantity: 20,
    category_slug: 'electronics',
    brand: 'ViewMaster',
    tags: ['√©cran', '4k', 'moniteur', 'hdr']
  },
  {
    name: 'Webcam HD 1080p',
    description: 'Webcam haute d√©finition avec micro int√©gr√©, id√©ale pour le t√©l√©travail',
    price: 89.99,
    sku: 'WEBCAM-HD-1080',
    inventory_quantity: 60,
    category_slug: 'electronics',
    brand: 'StreamTech',
    tags: ['webcam', 'hd', 't√©l√©travail', 'streaming'],
    featured: true
  },
  {
    name: 'Chargeur Sans Fil Rapide',
    description: 'Station de charge sans fil 15W compatible iPhone et Android',
    price: 39.99,
    sku: 'CHARGER-WIRELESS-15W',
    inventory_quantity: 80,
    category_slug: 'electronics',
    brand: 'PowerMax',
    tags: ['chargeur', 'sans-fil', 'qi', 'rapide']
  },
  {
    name: 'Montre Connect√©e Sport',
    description: 'Smartwatch avec GPS, capteur cardiaque, √©tanche, autonomie 7 jours',
    price: 199.99,
    sku: 'SMARTWATCH-SPORT-GPS',
    inventory_quantity: 40,
    category_slug: 'electronics',
    brand: 'FitTracker',
    tags: ['montre', 'connect√©e', 'sport', 'gps']
  },
  {
    name: 'Enceinte Bluetooth Portable',
    description: 'Haut-parleur Bluetooth √©tanche IPX7, son 360¬∞, autonomie 12h',
    price: 79.99,
    sku: 'SPEAKER-BT-PORTABLE-12H',
    inventory_quantity: 55,
    category_slug: 'electronics',
    brand: 'SoundWave',
    tags: ['enceinte', 'bluetooth', 'portable', '√©tanche'],
    featured: true
  },
  
  // Clothing
  {
    name: 'Hoodie Unisexe Premium',
    description: 'Sweat √† capuche unisexe en coton bio, coupe d√©contract√©e, plusieurs coloris',
    price: 79.99,
    compare_at_price: 99.99,
    sku: 'HOODIE-UNISEX-PREMIUM',
    inventory_quantity: 60,
    category_slug: 'clothing',
    brand: 'UrbanStyle',
    tags: ['hoodie', 'unisexe', 'coton', 'bio']
  },
  {
    name: 'Baskets Running Femme',
    description: 'Chaussures de running l√©g√®res avec amorti responsive, parfaites pour le sport',
    price: 129.99,
    sku: 'SNEAKERS-RUN-WOMEN',
    inventory_quantity: 45,
    category_slug: 'clothing',
    brand: 'SportFlow',
    tags: ['baskets', 'running', 'femme', 'sport'],
    featured: true
  },
  {
    name: 'Veste en Cuir Homme',
    description: 'Veste en cuir v√©ritable, style motard, coupe slim, finitions soign√©es',
    price: 299.99,
    sku: 'JACKET-LEATHER-MEN',
    inventory_quantity: 25,
    category_slug: 'clothing',
    brand: 'LeatherCraft',
    tags: ['veste', 'cuir', 'homme', 'motard']
  },
  {
    name: 'Robe d\'√©t√© Fleurie',
    description: 'Robe l√©g√®re en viscose avec motifs floraux, parfaite pour l\'√©t√©',
    price: 59.99,
    compare_at_price: 79.99,
    sku: 'DRESS-SUMMER-FLORAL',
    inventory_quantity: 35,
    category_slug: 'clothing',
    brand: 'SummerVibes',
    tags: ['robe', '√©t√©', 'fleurie', 'viscose']
  },
  {
    name: 'Sac √† Dos Urbain',
    description: 'Sac √† dos moderne avec compartiment laptop, port USB, r√©sistant √† l\'eau',
    price: 59.99,
    compare_at_price: 79.99,
    sku: 'BACKPACK-URBAN-LAPTOP',
    inventory_quantity: 35,
    category_slug: 'clothing',
    brand: 'CityBag',
    tags: ['sac', 'dos', 'urbain', 'laptop']
  },
  {
    name: 'Lunettes de Soleil Aviateur',
    description: 'Lunettes de soleil style aviateur, verres polaris√©s, protection UV 100%',
    price: 119.99,
    sku: 'SUNGLASSES-AVIATOR-UV',
    inventory_quantity: 45,
    category_slug: 'clothing',
    brand: 'SunStyle',
    tags: ['lunettes', 'soleil', 'aviateur', 'uv'],
    featured: true
  },
  
  // Home & Garden
  {
    name: 'Lampe de Bureau LED',
    description: 'Lampe de bureau moderne avec variateur, port USB, design √©pur√©',
    price: 89.99,
    sku: 'LAMP-DESK-LED-USB',
    inventory_quantity: 50,
    category_slug: 'maison-jardin',
    brand: 'LightHome',
    tags: ['lampe', 'bureau', 'led', 'usb'],
    featured: true
  },
  {
    name: 'Coussin D√©coratif Set',
    description: 'Set de 4 coussins d√©coratifs en velours, coloris assortis, 45x45cm',
    price: 49.99,
    compare_at_price: 69.99,
    sku: 'CUSHION-SET-VELVET-4',
    inventory_quantity: 30,
    category_slug: 'maison-jardin',
    brand: 'CozyHome',
    tags: ['coussin', 'd√©coratif', 'velours', 'set']
  },
  {
    name: 'Plante Artificielle Monstera',
    description: 'Monstera deliciosa artificielle 120cm, tr√®s r√©aliste, pot inclus',
    price: 79.99,
    sku: 'PLANT-ARTIFICIAL-MONSTERA',
    inventory_quantity: 25,
    category_slug: 'maison-jardin',
    brand: 'GreenDecor',
    tags: ['plante', 'artificielle', 'monstera', 'd√©coration']
  },
  {
    name: 'Tapis Berb√®re Moderne',
    description: 'Tapis style berb√®re 160x230cm, motifs g√©om√©triques, fibres naturelles',
    price: 159.99,
    sku: 'RUG-BERBER-MODERN-160',
    inventory_quantity: 15,
    category_slug: 'maison-jardin',
    brand: 'RugCraft',
    tags: ['tapis', 'berb√®re', 'g√©om√©trique', 'naturel']
  },
  {
    name: 'Kit Caf√© Barista',
    description: 'Kit complet pour faire un caf√© comme un barista : moussoir, doseur, tamper',
    price: 89.99,
    sku: 'COFFEE-KIT-BARISTA',
    inventory_quantity: 25,
    category_slug: 'maison-jardin',
    brand: 'CoffeePro',
    tags: ['caf√©', 'barista', 'kit', 'moussoir']
  },
  
  // Books
  {
    name: 'Guide Photographie Num√©rique',
    description: 'Manuel complet de photographie num√©rique, techniques avanc√©es et astuces',
    price: 39.99,
    sku: 'BOOK-PHOTO-DIGITAL-GUIDE',
    inventory_quantity: 40,
    category_slug: 'books',
    brand: 'PhotoEditions',
    tags: ['livre', 'photographie', 'num√©rique', 'guide']
  },
  {
    name: 'Roman Fantasy √âpique',
    description: 'Trilogie fantasy compl√®te, monde imaginaire riche, aventure √©pique',
    price: 29.99,
    compare_at_price: 34.99,
    sku: 'BOOK-FANTASY-TRILOGY',
    inventory_quantity: 60,
    category_slug: 'books',
    brand: 'FantasyPress',
    tags: ['livre', 'fantasy', 'roman', 'trilogie']
  }
]

async function addProductsAsAdmin() {
  try {
    log('üöÄ Adding Products with Admin Privileges', 'blue')
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'blue')

    // Check if .env.local exists
    const envPath = path.join(process.cwd(), '.env.local')
    if (!fs.existsSync(envPath)) {
      log('‚ùå .env.local file not found!', 'red')
      return
    }

    // Load environment variables
    require('dotenv').config({ path: envPath })
    
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY

    if (!supabaseUrl || !serviceRoleKey) {
      log('‚ùå Missing Supabase Service Role Key in .env.local', 'red')
      log('Please add: SUPABASE_SERVICE_ROLE_KEY=your_service_role_key', 'yellow')
      log('You can find this in your Supabase Dashboard > Settings > API', 'yellow')
      return
    }

    // Create Supabase client with service role key (bypasses RLS)
    const supabase = createClient(supabaseUrl, serviceRoleKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    })

    // Get categories first
    log('\nüîç Fetching categories...', 'yellow')
    const { data: categories, error: catError } = await supabase
      .from('categories')
      .select('id, slug')

    if (catError) {
      log(`‚ùå Error fetching categories: ${catError.message}`, 'red')
      return
    }

    const categoryMap = {}
    categories.forEach(cat => {
      categoryMap[cat.slug] = cat.id
    })

    log(`‚úÖ Found ${categories.length} categories`, 'green')

    // Add products
    log('\nüõçÔ∏è Adding new products...', 'yellow')
    let successCount = 0
    let skipCount = 0
    let errorCount = 0

    for (const productData of newProducts) {
      try {
        // Check if product already exists
        const { data: existing } = await supabase
          .from('products')
          .select('sku')
          .eq('sku', productData.sku)
          .single()

        if (existing) {
          log(`‚è≠Ô∏è Skipping existing product: ${productData.name} (${productData.sku})`, 'yellow')
          skipCount++
          continue
        }

        // Get category ID
        const categoryId = categoryMap[productData.category_slug]
        if (!categoryId) {
          log(`‚ùå Category not found for: ${productData.category_slug}`, 'red')
          errorCount++
          continue
        }

        // Prepare product data
        const insertData = {
          name: productData.name,
          description: productData.description,
          price: productData.price,
          compare_at_price: productData.compare_at_price || null,
          sku: productData.sku,
          inventory_quantity: productData.inventory_quantity,
          category_id: categoryId,
          brand: productData.brand,
          tags: productData.tags,
          featured: productData.featured || false
        }

        // Insert product using service role (bypasses RLS)
        const { error: insertError } = await supabase
          .from('products')
          .insert([insertData])

        if (insertError) {
          log(`‚ùå Error adding ${productData.name}: ${insertError.message}`, 'red')
          errorCount++
        } else {
          log(`‚úÖ Added: ${productData.name}`, 'green')
          successCount++
        }

      } catch (err) {
        log(`‚ùå Unexpected error for ${productData.name}: ${err.message}`, 'red')
        errorCount++
      }
    }

    // Final summary
    log('\nüìä Summary:', 'bold')
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'blue')
    log(`‚úÖ Successfully added: ${successCount} products`, 'green')
    log(`‚è≠Ô∏è Skipped existing: ${skipCount} products`, 'yellow')
    log(`‚ùå Errors: ${errorCount} products`, 'red')

    // Check final product count
    const { data: finalProducts } = await supabase
      .from('products')
      .select('id')

    log(`\nüéØ Total products in database: ${finalProducts?.length || 0}`, 'blue')

    if (successCount > 0) {
      log('\nüéâ Success! Your e-commerce platform now has:', 'green')
      log('‚úÖ Comprehensive product catalog', 'green')
      log('‚úÖ Diverse categories with real products', 'green')
      log('‚úÖ Proper inventory and pricing', 'green')
      log('‚úÖ Featured products for homepage', 'green')
      log('‚úÖ Product images and descriptions', 'green')
      
      log('\nüöÄ Next steps:', 'yellow')
      log('1. Run: npm run dev', 'blue')
      log('2. Visit: http://localhost:3010', 'blue')
      log('3. Check the homepage and product pages', 'blue')
    }

  } catch (error) {
    log(`üí• Unexpected error: ${error.message}`, 'red')
    console.error(error)
  }
}

// Run the script
addProductsAsAdmin().catch(console.error)